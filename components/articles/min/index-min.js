app.articlesView=kendo.observable({mode:"news",categories:[],videoArticles:[],swiperCategories:null,swiperArticles:null,swiperVideo:null,tplArticles:null,initialSlide:app.webservices.newsPosition,forceReload:!1,onInit:function(){app.mobileApp.showLoading(),lscache.set("refreshData",!1),app.articlesView.set("translations",app.translations),app.articlesView.translations.bind("change",function(e){"selectedLanguage"==e.field&&("components/articles/view.html"==app.mobileApp.view().id?(app.articlesView.resetData(),app.articlesView.loadData()):app.articlesView.forceReload=!0)}),app.articlesView.tplArticles=kendo.template($("#articlesViewArticleTemplate").html()),$(document).on("click","#articlesView .card",function(e){e.preventDefault();var i=$(e.currentTarget).data("type");if(2==i){var t=$(e.currentTarget).data("id");$("[id=pictureDetail-"+t+"]").insertAfter($(".km-header")).fadeToggle()}else app.mobileApp.navigate("components/article/view.html?id="+$(e.currentTarget).data("id"),"slide")}),$(document).on("click","#articlesView .closeButton",function(e){var i=$(e.currentTarget).data("id");i=i.replace("closePictureDetail-",""),$("[id=pictureDetail-"+i+"]").fadeToggle()}),app.articlesView.loadData()},onShow:function(e){var i=lscache.get("refreshData"),t="news";e.view.params.mode&&(t=e.view.params.mode);var a=app.webservices.newsPosition;void 0!==e.view.params.idx&&(a=e.view.params.idx),app.articlesView.mode!=t?(app.articlesView.mode=t,app.articlesView.initialSlide=a,app.articlesView.resetData(),app.articlesView.loadData()):1==i||"true"==i?(app.articlesView.resetData(),app.articlesView.loadData(),lscache.set("refreshData",!1)):app.articlesView.forceReload?(app.articlesView.resetData(),app.articlesView.loadData()):app.articlesView.swiperCategories&&app.articlesView.swiperCategories.activeIndex!=a?(app.articlesView.initialSlide=a,app.articlesView.swiperCategories.slideTo(app.articlesView.initialSlide)):$(".swiper-categories .swiper-slide-active").length&&app.analytics.trackPage("Articles List : "+$(".swiper-categories .swiper-slide-active").data("analytic-title"))},resetData:function(){app.mobileApp.showLoading(),this.swiperCategories.destroy(!0,!0),this.swiperArticles.destroy(!0,!0),$("#articlesView .swiper-wrapper").html("")},loadData:function(){"news"==this.mode?app.webservices.getArticlesCategories().done(function(e){app.articlesView.set("categories",e)}):app.webservices.getProfessionCategories().done(function(e){app.articlesView.set("categories",e)}),app.webservices.getLastVideoArticles().done(function(e){app.articleView.set("videoArticles",e)})},updateQueryStringParameter:function(e,i,t){var a=new RegExp("([?&])"+i+"=.*?(&|$)","i"),s=-1!==e.indexOf("?")?"&":"?";return e.match(a)?e.replace(a,"$1"+i+"="+t+"$2"):e+s+i+"="+t},onCategoriesLoaded:function(){var e=this;e.categories.length&&setTimeout(function(){e.swiperCategories=new Swiper("#articlesView .swiper-categories",{initialSlide:e.initialSlide,spaceBetween:50,centeredSlides:!0,slidesPerView:"auto",touchRatio:.2,slideToClickedSlide:!0,onSlideChangeEnd:function(e){window.location.hash=app.articlesView.updateQueryStringParameter(window.location.hash,"idx",e.activeIndex),app.analytics.trackPage("Articles List : "+$(".swiper-categories .swiper-slide-active").data("analytic-title"))}}),e.swiperArticles&&(e.swiperArticles.params.control=e.swiperCategories,e.swiperCategories.params.control=e.swiperArticles)},100)},onVideoArticlesLoaded:function(){var e=this;0===e.videoArticles.length&&setTimeout(function(){e.swiperVideo=new Swiper("#articlesView .swiper-videos",{initialSlide:e.initialSlide,pagination:".swiper-pagination",paginationClickable:!0,slidesPerView:"auto",paginationClickable:!0,spaceBetween:30})},100)},onArticlesLoaded:function(){this.categories.length&&(this.swiperArticles=new Swiper("#articlesView .swiper-articles",{initialSlide:this.initialSlide,spaceBetween:0,onInit:function(){var e=$("#articlesView .swiper-articles .swiper-slide"),i=$(e[app.articlesView.initialSlide]);$.when(app.webservices.getTopArticles("news"==app.articlesView.mode?null:i.data("id"),"news"!=app.articlesView.mode),app.webservices.getArticles("news"==app.articlesView.mode?null:i.data("id"),0,"news"!=app.articlesView.mode),i).done(function(e,i,t){app.articlesView.renderTopArticles(t,e),e.forEach(function(e){2==e.articleType&&($("[id=pictureClick-"+e.id+"]").show(),$("[id=pictureClick-"+e.id+"]").addClass("picture"))},this),app.articlesView.renderArticles(t,i,!1),i.forEach(function(e){2==e.articleType&&($("[id=pictureClick-"+e.id+"]").show(),$("[id=pictureClick-"+e.id+"]").parent().addClass("picture"))},this),app.articlesView.forceReload=!1,$(".swiper-videos").insertAfter($(".buttonSeeMore")).show(),setTimeout(function(){this.swiperVideo=new Swiper("#articlesView .swiper-videos",{initialSlide:this.initialSlide,pagination:".swiper-pagination",paginationClickable:!0,slidesPerView:"auto",paginationClickable:!0,spaceBetween:30})},100),app.mobileApp.hideLoading()});for(var t=0;t<app.articlesView.categories.length;t++)t!=app.articlesView.initialSlide&&(i=$(e[t]),$.when(app.webservices.getTopArticles(i.data("id"),"news"!=app.articlesView.mode),app.webservices.getArticles(i.data("id"),0,"news"!=app.articlesView.mode),i).done(function(e,i,t){app.articlesView.renderTopArticles(t,e),e.forEach(function(e){2==e.articleType&&$("[id=pictureClick-"+e.id+"]").show()},this),app.articlesView.renderArticles(t,i,!1),i.forEach(function(e){2==e.articleType&&$("[id=pictureClick-"+e.id+"]").show()},this)}))}}),this.swiperCategories&&(this.swiperArticles.params.control=this.swiperCategories,this.swiperCategories.params.control=this.swiperArticles))},renderTopArticles:function(e,i){e.find(".topStories").html(kendo.render(this.tplArticles,i)).waitForImages(!0).progress(function(){$(this).css("visibility","")})},renderArticles:function(e,i,t){var a=e.find(".recentArticles .buttonSeeMore"),s="";t||(a.data("page",0).prevAll().remove(),null==e.data("id")&&(s+='<h2 class="title">'+app.translations.texts.recent_news+"</h2>")),s+=kendo.render(this.tplArticles,i),a.before(s),a.data("page",a.data("page")+1).toggle(i.length==app.webservices.articlesPageSize),e.find(".recentArticles").waitForImages(!0).progress(function(){$(this).css("visibility","")});var r=e.find(".card"),l=e.find(".tooltipDate"),p=e.find("[data-role=scroller]").data("kendoMobileScroller").scrollElement;p.bind("scroll",function(i){if($(e.find(".card")[0]).offset().top>85)return void l.hide();l.show();var t=l.offset().top,a=null;if(r.each(function(){t>=$(this).offset().top&&(a=$(this))}),a){var s=a.data("date");s?l.text(moment(a.data("date")).fromNow()):l.text(app.translations.texts.in_the_news)}else l.hide()}),p.trigger("scroll")},loadMore:function(e){e.preventDefault(),app.analytics.trackEvent("User Action","Load More",$(".swiper-categories .swiper-slide-active").data("analytic-title")),app.mobileApp.showLoading();var i=$(e.currentTarget),t=i.closest(".swiper-slide");app.webservices.getArticles(t.data("id"),i.data("page")*app.webservices.articlesPageSize,"news"!=app.articlesView.mode).done(function(e){app.articlesView.renderArticles(t,e,!0),app.mobileApp.hideLoading()})}});